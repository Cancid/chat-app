<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Chat</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="">
  </head>
  <body>
    <form id="login" action="" >
      <input id="username"/>
      <button>Let's Chat!</button>
    </form>
    <ul id="users" action=""></ul>
    <div id="chatbox"style="display: none">
      <ul id="messages">Message Log</ul>
      <form id="form" action="" >
        <input id="input" /><button>Send</button>
      </form>
    <script src="/socket.io/socket.io.js"></script>
    <script>
      const socket = io({
        autoconnect: false,
        transports: ['websocket'], });
      const chatbox = document.getElementById('chatbox');
      const messages = document.getElementById('messages');
      const login = document.getElementById('login');
      const username = document.getElementById('username');
      const form = document.getElementById('form');
      const input = document.getElementById('input');
      const onlineUsers = document.getElementById('users');

      let userList = []

      login.addEventListener('submit', (event) => {
        event.preventDefault();
        if (username.value) {
          socket.auth = { username: username.value };
          console.log(socket)
          socket.connect();
          chatbox.style = "display: inline-block"
        }
      });

      socket.onAny((event, ...args) => {
        console.log(event, args);
      });
      
      form.addEventListener('submit', function(event) {
        event.preventDefault();
        console.log(input.value);
        if (input.value) {
          let message = `${user}: ${input.value}`
          createItem(message);
          socket.emit('chat message', message);
          input.value = '';
        };
      });

      const createItem = (message) => {
        let item = document.createElement('li');
          item.textContent = message;
          messages.appendChild(item);
      };

      socket.on('connection', function(connection) {
        console.log(connection);
      });

      socket.on('users', (users) => {
        userList = users.username;
        users.forEach(user => {
          let item = document.createElement('li');
          item.textContent = user.username;
          onlineUsers.appendChild(item);
        });
      });

      socket.on('userJoined', (user) => {
        let item = document.createElement('li');
        item.textContent = `${user} has joined the chat!`;
        messages.appendChild(item);
      });


      socket.on('userDisconnect', function(userDisconnect) {
        console.log(userDisconnect);
      });

      socket.on('chat message', function(msg) {
        createItem(input.value);
        window.scrollTo(0, document.body.scrollHeight);
      });
    </script>
  </body>
</html>